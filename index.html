<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>WebAR Camera + MediaPipe Hands + Three.js</title>

<!-- Three.js from unpkg -->
<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>

<!-- MediaPipe Hands -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<style>
  body { margin: 0; overflow: hidden; background: black; }
  #startBtn {
    position: fixed;
    bottom: 20px;
    left: 20px;
    padding: 12px 20px;
    background: #00aaff;
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 18px;
    z-index: 9999;
  }
  video {
    display: none;
  }
</style>
</head>
<body>

<button id="startBtn">ğŸ“¸ å¯åŠ¨ AR ç›¸æœº</button>
<video id="inputVideo" playsinline></video>

<script>
/* ---------------------------------------------------------
   1. åˆå§‹åŒ– Three.js åŸºç¡€åœºæ™¯
--------------------------------------------------------- */
const scene = new THREE.Scene();

const camera3D = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 100);
camera3D.position.z = 3;

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

/* ---------------------------------------------------------
   2. ç®€å• 3D å¯¹è±¡ï¼ˆä¹‹åæ¢æˆä½ çš„ GPU ç²’å­ï¼‰
--------------------------------------------------------- */
const geo = new THREE.SphereGeometry(0.5, 32, 32);
const mat = new THREE.MeshBasicMaterial({ color: 0x00ffff, wireframe: true });
const sphere = new THREE.Mesh(geo, mat);
scene.add(sphere);

/* ---------------------------------------------------------
   3. ç›¸æœºåˆå§‹åŒ–ï¼ˆå¿…é¡»ç”±ç”¨æˆ·ç‚¹å‡»è§¦å‘ï¼‰
--------------------------------------------------------- */
const inputVideo = document.getElementById("inputVideo");

async function startCamera() {
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "user" }
  });
  inputVideo.srcObject = stream;
  await inputVideo.play();
}

/* ---------------------------------------------------------
   4. é…ç½® MediaPipe Hands
--------------------------------------------------------- */
const hands = new Hands({
  locateFile: (file) =>
    `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
});

hands.setOptions({
  maxNumHands: 1,
  modelComplexity: 1,
  minDetectionConfidence: 0.6,
  minTrackingConfidence: 0.6
});

hands.onResults((results) => {
  if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
    const hand = results.multiHandLandmarks[0];

    // ç®€å•ç¤ºä¾‹ï¼šæ ¹æ®æ‰‹æŒä½ç½®ç§»åŠ¨çƒ
    const x = (hand[9].x - 0.5) * 2;
    const y = -(hand[9].y - 0.5) * 2;
    sphere.position.x += (x - sphere.position.x) * 0.1;
    sphere.position.y += (y - sphere.position.y) * 0.1;
  }
});

/* ä½¿ç”¨ MediaPipe çš„æ‘„åƒå¤´å·¥å…· */
let mpCamera;

/* ---------------------------------------------------------
   5. ç‚¹å‡»æŒ‰é’® â†’ å¼€å§‹ç›¸æœº + MediaPipe
--------------------------------------------------------- */
document.getElementById("startBtn").onclick = async () => {
  document.getElementById("startBtn").style.display = "none";

  // å¯åŠ¨çœŸæ­£çš„æ‘„åƒå¤´
  await startCamera();

  // å¯åŠ¨ MediaPipe Hands
  mpCamera = new Camera(inputVideo, {
    onFrame: async () => {
      await hands.send({ image: inputVideo });
    },
    width: 640,
    height: 480
  });
  mpCamera.start();
};

/* ---------------------------------------------------------
   6. æ¸²æŸ“å¾ªç¯
--------------------------------------------------------- */
function animate() {
  requestAnimationFrame(animate);
  renderer.render(scene, camera3D);
}
animate();

/* ---------------------------------------------------------
   7. å¤„ç†çª—å£ç¼©æ”¾
--------------------------------------------------------- */
window.addEventListener("resize", () => {
  camera3D.aspect = window.innerWidth / window.innerHeight;
  camera3D.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>

</body>
</html>
